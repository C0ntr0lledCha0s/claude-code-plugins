#!/bin/sh

# Get list of staged files
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM)

if [ -z "$STAGED_FILES" ]; then
    echo "No files staged for commit."
    exit 0
fi

echo "üîç Validating staged files..."

ERRORS=0

# Validate changed agents (exclude reference files and templates)
for file in $STAGED_FILES; do
    if echo "$file" | grep -q "agents/.*\.md$" && ! echo "$file" | grep -qE "(references/|templates/|assets/)"; then
        echo "  Validating agent: $file"
        if ! python3 agent-builder/skills/building-agents/scripts/validate-agent.py "$file" 2>&1; then
            ERRORS=$((ERRORS + 1))
        fi
    fi
done

# Validate changed commands (exclude SKILL.md, templates, and references)
for file in $STAGED_FILES; do
    if echo "$file" | grep -q "commands/.*\.md$" && ! echo "$file" | grep -qE "(SKILL\.md$|templates/|references/|assets/)"; then
        echo "  Validating command: $file"
        if ! python3 agent-builder/skills/building-commands/scripts/validate-command.py "$file" 2>&1; then
            ERRORS=$((ERRORS + 1))
        fi
    fi
done

# Validate changed hooks.json files
for file in $STAGED_FILES; do
    if echo "$file" | grep -q "hooks/hooks\.json$"; then
        echo "  Validating hooks: $file"
        if ! python3 agent-builder/skills/building-hooks/scripts/validate-hooks.py "$file" 2>&1; then
            ERRORS=$((ERRORS + 1))
        fi
    fi
done

# Validate changed skills (check if SKILL.md changed)
for file in $STAGED_FILES; do
    if echo "$file" | grep -q "skills/.*/SKILL\.md$"; then
        skill_dir=$(dirname "$file")
        echo "  Validating skill: $skill_dir"
        if ! python3 agent-builder/skills/building-skills/scripts/validate-skill.py "$skill_dir" 2>&1; then
            ERRORS=$((ERRORS + 1))
        fi
    fi
done

# Validate plugin.json if changed
for file in $STAGED_FILES; do
    if echo "$file" | grep -q "\.claude-plugin/plugin\.json$"; then
        echo "  Validating plugin manifest: $file"
        if ! python3 -m json.tool "$file" >/dev/null 2>&1; then
            echo "    ‚ùå Invalid JSON in $file"
            ERRORS=$((ERRORS + 1))
        fi
    fi
done

# Validate marketplace.json if changed
for file in $STAGED_FILES; do
    if echo "$file" | grep -q "\.claude-plugin/marketplace\.json$"; then
        echo "  Validating marketplace: $file"
        if ! python3 -m json.tool "$file" >/dev/null 2>&1; then
            echo "    ‚ùå Invalid JSON in $file"
            ERRORS=$((ERRORS + 1))
        fi
    fi
done

# Run security checks on staged files only
echo "üîç Running security checks..."

# Check for hardcoded paths in staged hooks.json files
for file in $STAGED_FILES; do
    if echo "$file" | grep -q "hooks\.json$"; then
        if grep -q "github-workflows/hooks" "$file" 2>/dev/null; then
            echo "‚ùå Found hardcoded plugin paths in $file (use \${PLUGIN_DIR} instead)"
            ERRORS=$((ERRORS + 1))
        fi
    fi
done

# Check for secrets in staged files
for file in $STAGED_FILES; do
    if echo "$file" | grep -qE "\.(sh|py|md)$"; then
        if grep -iE "(password|secret|api[_-]?key|token)\s*=\s*['\"][^'\"]+['\"]" "$file" 2>/dev/null; then
            echo "‚ö†Ô∏è  Warning: Potential secrets found in $file"
        fi
    fi
done

if [ $ERRORS -gt 0 ]; then
    echo ""
    echo "‚ùå Pre-commit validation failed with $ERRORS error(s). Please fix before committing."
    exit 1
fi

echo "‚úÖ Pre-commit validation passed!"
